---
网络: 网络 IP 数据包
---

# IP 数据包的格式

ip 数据包格式如下
 
![](.gitbook/assets/ip.png)


* 版本 IP 协议的版本， 目前协议版本号为4 下一代为6

* 首部长度， IP报文首部的长度。 固定部分的长度为20字节。 和可变长度之和。 一共占4位， 所以值最大是15， 但是单位是4字节。 所以IP报文首部长度最大是 15 \* 4 = 60字节。 出去固定部分的长度20字节， 可变长度最大为40字节. 举个例子， ICMP回显请求，有可能会打开RR选项（record route），会记录经过的路由，但是IP首部只有有限的空间来存放IP，只有可变长度选项里能够存，最大为40字节。一个ip地址为4字节， 因此最多能够存9个ip地址。

* 服务类型： 

* 总长度， ip报文的总长度， 首部+ 数据报文的 长度之和

* 标示 唯一的标示主机发送的每一份数据包， 通常每发送一个报文， 它的值加1， 当ip报文长度超过传输的MTU时候， 必须分片，这个标识字段的值被复制到所有数据分片的标示字段中， 似的这些分片在达到最终目的时候可以依照标识字段的内容重新组成原先的数据

* 片偏移， 本分片在原先数据报文中相对首部的偏移位置（需要再乘以8）， 所以使用标示和片偏移 两个值，才能重新组合起原来的数据报文

* 生存时间  IP报文云晓通过的路由器的最大数量，没经过一个路由器 TTL减去1 ， 当为0 时候， 路由器将该数据包文丢弃。 TTL字段的发送值 当前为64 但是回显时候 一般设置为最大值225。 ttl 可以防止网络出现环路时候， ip数据包无休止的传递下去

* 协议： IP报文携带的数据使用的是哪种协议。 以便目的主机的IP层 能知道要将数据报文上交到哪个进程，和端口号类似。 此处采用协议号， TCP的协议号为6 UDP 为17 ICMP为1 IGMP为2

* 首部校验和， 计算IP头部的校验和， 检查IP抱头的完整性， 使用反码求和。

* 源IP， 目的IP



# traceroute

traceroute 包含了对icmp 和udp 协议的使用， 它充分利用了ip 数据包中的ttl字段

正常ping 程序中有 -R 选项， 来记录经过的路由，那为什么不是用ping 而重新开发traceroute 呢， 

* 首先并不是所有的路由器都支持记录路由选项， 因此该选项在某些路径上不能够使用

* 其次 记录路由 一般是单向的选项， 发送端设置了该选型，那么接收端不得不从收到的ip首部中提取所有的信息， 然后全部返回给发送端. 我么可以通过下图可以看到 大多数ping 服务器的实现把接受到的RR清单返回， 但是这样是记录下来的IP地址翻了一遍，这样做会收到一些限制

![](.gitbook/assets/ping_rr.png)


* 最后一个原因， 也是醉主要的原因IP首部中留给选项的空间有限， 最多能保存9个ip地址。

traceroute 使用icmp 报文和IP首部中的TTL字段，TTL 字段发送时候一般默认是64 ，ICMP回显应答经常把TTL设置为最大值255

每个处理数据报文的路由器需要吧TTL的值减去1， 或者减去数据报在路由器中停留的秒数。 由于大多数的路由器转发数据报文的时延都小于1秒钟， 因此TTL最终成为一个跳站的计数器。所以没经过一个路由器都会将值减去1

TTL 字段的目的是防止数据报在选路时候无休止的在网络中流动

当路由器收到一份IP数据报，如果其TTL字段是0或者是1， 则路由器不转发该数据报。相反 路由器将该数据报丢弃， 并给信源机 发一份ICMP “超时” 信息， traceroute 关键在于包含这份ICMP信息的IP报文的心愿地址是该路由器的IP地址。

## traceroute 操作过程

首先它发送一份TTL字段为1 的**IP数据报**给目的主机， 处理这份数据报的第一个路由器将TLL减去1， 丢弃该数据报， 并返回一份超时ICMP报文， 这样，traceroute 就得到了该路径中的第一个路由器的地址。然后traceroute 程序发送一份TTL为2 的数据报。

这样我们就可以得到第二个路由器的地址。 继续这个过程直至该数据报到达目的主机。

**但是** 目的主机哪怕接受到TTL为1的IP数据报时候， 也不会丢弃该数据报并禅师一份超时ICMP报文， 这是因为数据报已经达到最终目的， 那么我们改如何判断是否已经到达目的主机了呢？

traceroute 程序发送一份**UDP 数据报**给目的主机， 但是它会hack一下 ， 选择一个**不可能的值作为UPD号（大于30000）** ，使目的主机的任何一个应用程序都不可能使用该端口。 因为当该数据报到达时候， 将是目的主机的UDP模块产生一份 **端口不可达**的错误的ICMP报文

这样 Traceroute 程序所要做的就是区分接受到的ifmp报文是超时还是端口不可达， 以判断什么时候结束。

 


