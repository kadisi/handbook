# tcp 协议

## ISO 网络模型

ISO 网络模型，分七层，从上到下依次为

| 层 | 协议 |
| :--- | :--- |
| 应用层 | http ftp 。。。 |
| 表示层 | 无协议， https 的加密可能在此层 |
| 回话层 | 无协议， http 的session 可能在此层 |
| 传输层 | tcp udp |
| 网络层 | ip icmp |
| 数据链路层 | arp |
| 物理层 | iso2110 ieee802 |

TCP 在传输层， IP 在网络层， 传输层在网络层上面， 传输层tcp包含重要的源端口和目的端口字段， IP网络层包含 源ip 目的ip 字段， 只有源端口， 目的端口， 源ip， 目的ip 才能形成一个tcp 链接

![](../../.gitbook/assets/image%20%284%29.png)

  


![](../../.gitbook/assets/image%20%281%29.png)

## TCP 连接 三次握手

三次握手的简单理解

![](../../.gitbook/assets/image%20%282%29.png)

1 发送方 问 接收方 听得到吗

2 接收方 返回 听得到， 你能听得到我吗

3 发送方回复， 我也听到了，咱们开干吧

## TCP 头部

![](../../.gitbook/assets/image%20%285%29.png)

在TCP报文， 外包包的是IP 层的首部， IP层的数据部分 就是TCP 数据包。

源、目的端口： 在TCP数据包中， 一般默认是20字节的报文首部， 首部结构如上图所示， 包含源端口， 和目的端口（注意:在TCP数据包问头部中 并没有源IP和目的IP，源IP和目的IP的信息在IP报文头部），分别占用16位，表示源端口号和目的端口号；用于区别主机中的不同进程，而IP地址是用来区分不同的主机的，源端口号和目的端口号配合上IP首部中的源IP地址和目的IP地址就能唯一的确定一个TCP连接；16位 最大为65535 这也就说明端口的最大范围为0-65535.

序号： Sequence Number:用来标识从TCP发端向TCP收端发送的数据字节流，它表示在这个报文段中的的第一个数据字节在数据流中的序号；主要用来解决网络报乱序的问题；

确认号：Acknowledgment Number:32位确认序列号包含发送确认的一端所期望收到的下一个序号，因此，确认序号应当是上次已成功收到数据字节序号加1。不过，只有当标志位中的ACK标志（下面介绍）为1时该确认序列号的字段才有效。主要用来解决不丢包的问题；

TCP Flags:TCP首部中有6个标志比特，它们中的多个可同时被设置为1，主要是用于操控TCP的状态机的，依次为URG，ACK，PSH，RST，SYN，FIN。每个标志位的意思如下：



> SYN：表示同步序号，用来建立连接。SYN标志位和ACK标志位搭配使用，当连接请求的时候，SYN=1，ACK=0；连接被响应的时候，SYN=1，ACK=1；这个标志的数据包经常被用来进行端口扫描。扫描者发送一个只有SYN的数据包，如果对方主机响应了一个数据包回来 ，就表明这台主机存在这个端口；但是由于这种扫描方式只是进行TCP三次握手的第一次握手，因此这种扫描的成功表示被扫描的机器不很安全，一台安全的主机将会强制要求一个连接严格的进行TCP的三次握手；
>
> FIN： 表示发送端已经达到数据末尾，也就是说双方的数据传送完成，没有数据可以传送了，发送FIN标志位的TCP数据包后，连接将被断开。这个标志的数据包也经常被用于进行端口扫描。
>
> ACK：此标志表示应答域有效，就是说前面所说的TCP应答号将会包含在TCP数据包中；有两个取值：0和1，为1的时候表示应答域有效，反之为0；

**ACK ： TCP协议规定，只有ACK=1时有效，也规定连接建立后所有发送的报文的ACK必须为1**

**SYN\(SYNchronization\) ： 在连接建立时用来同步序号。当SYN=1而ACK=0时，表明这是一个连接请求报文。对方若同意建立连接，则应在响应报文中使SYN=1和ACK=1. 因此, SYN置1就表示这是一个连接请求或连接接受报文。**

**FIN （finis）即完，终结的意思， 用来释放一个连接。当 FIN = 1 时，表明此报文段的发送方的数据已经发送完毕，并要求释放连接。**

\*\*\*\*

理解这些信息后 我们再了解TCP 的三次握手和四次挥手

## TCP 三次握手

![](../../.gitbook/assets/image%20%287%29.png)



1. 第一次握手：建立连接。客户端发送连接请求报文段，将SYN位置为1，Sequence Number为x，请求的报文实际上还是一个tcp数据包，只不过这个包没有data， 最大的特点就是这个包的首部SYN标志位为1，代表了这个包是一个SYN包，而数据包中的确认号 Sequence Number x是随机产生的，因为是SYN包，所以确认号对数据的前后顺序不影响 ；然后，客户端进入SYN\_SEND状态，等待服务器的确认；
2. 第二次握手：服务器收到SYN报文段。服务器收到客户端的SYN报文段，需要对这个SYN报文段进行确认，设置Acknowledgment Number为x+1\(Sequence Number+1\)；同时，自己自己还要发送SYN请求信息，将SYN位置为1，Sequence Number为y，这个y也是服务器端随机产生的；服务器端将上述所有信息放到一个报文段（即SYN+ACK报文段）中，这个时候SYN字段是1， ACK 字段也是1，代表的是连接请求响应报文， 确认号字段为x+1，一并发送给客户端，此时服务器进入SYN\_RECV状态；
3. 第三次握手：客户端收到服务器的SYN+ACK报文段。然后将Acknowledgment Number设置为y+1，向服务器发送ACK报文段，这个报文段发送完毕以后，客户端和服务器端都进入ESTABLISHED状态，完成TCP三次握手。 完成了三次握手，客户端和服务器端就可以开始传送数据。以上就是TCP三次握手的总体介绍。 

第一次握手：客户端  发送TCP报文 SYN=1, ACK=0, SequenceNum=随机数x， AcknowledgeMentNum=0

第二次握手:  服务器端返回TCP报文 SYN=1, ACK=1, SequenceNum=随机数y， AcknowledgeMentNum=x+1

第三次握手: 客户端返回TCP报文  SYN=0 ACK=1, SequenceNum=0, AcknowledgeMentNum=y+1



## TCP 断开四次挥手

TCP断开的四次挥手通俗点讲：

TCP协议是一种面向连接的、可靠的、基于字节流的运输层通信协议。TCP是全双工模式，这就意味着，当主机1发出FIN报文段时，只是表示主机1已经没有数据要发送了，主机1告诉主机2，它的数据已经全部发送完毕了；但是，这个时候主机1还是可以接受来自主机2的数据；当主机2返回ACK报文段时，表示它已经知道主机1没有数据发送了，但是主机2还是可以发送数据到主机1的；当主机2也发送了FIN报文段时，这个时候就表示主机2也没有数据要发送了，就会告诉主机1，我也没有数据要发送了，之后彼此就会愉快的中断这次TCP连接。

简单理解：

第一次分手： 主机A ： 喂， 主机B， 我已经没有数据可以发送了，知道不？ （但是实际上 A是可以接受数据的，但是绝对不会发送数据了）

第二次分手： 主机B:  好的， 我知道了，主机A。 （这时候B 就不会接受A的数据了 ，但是还可能会发送给A数据）

第三次分手： 主机B：  喂，主机A， 我也没有数据可以发送了， 知道不？（这时候B是没数据可发了）

第四次分手： 主机A： 好的， 我也知道了，咱们拜拜吧，从此老死不相往来（A 知道B没数据可发后，俩人就开始拜拜了）

![](../../.gitbook/assets/image%20%286%29.png)



当客户端和服务器通过三次握手建立了TCP连接以后，当数据传送完毕，肯定是要断开TCP连接的啊。那对于TCP的断开连接，这里就有了神秘的“四次分手”。

1. 第一次分手：主机1（可以使客户端，也可以是服务器端），设置Sequence Number和Acknowledgment Number，向主机2发送一个FIN报文段，此报文段的FIN位为1，；此时，主机1进入FIN\_WAIT\_1状态；这表示主机1没有数据要发送给主机2了；
2. 第二次分手：主机2收到了主机1发送的FIN报文段，向主机1回一个ACK报文段，Acknowledgment Number为Sequence Number加1；主机1进入FIN\_WAIT\_2状态；主机2告诉主机1，我“同意”你的关闭请求；
3. 第三次分手：主机2向主机1发送FIN报文段，请求关闭连接，同时主机2进入LAST\_ACK状态；
4. 第四次分手：主机1收到主机2发送的FIN报文段，向主机2发送ACK报文段，然后主机1进入TIME\_WAIT状态；主机2收到主机1的ACK报文段以后，就关闭连接；此时，主机1等待2MSL后依然没有收到回复，则证明Server端已正常关闭，那好，主机1也可以关闭连接了。



链接引用:

> [https://github.com/jawil/blog/issues/14](https://github.com/jawil/blog/issues/14)

